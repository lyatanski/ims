include:
- core.yml


x-kamailio: &kamailio
  image: ghcr.io/kamailio/kamailio-ci:master-alpine
  command: -f /etc/ims/kamailio.cfg
  dns: ${DNS}

services:
  icscf:
    << : *kamailio
    environment:
      EPC_REALM: epc.mnc${MNC-001}.mcc${MCC-001}.3gppnetwork.org
    configs:
    - source: icscf.cfg
      target: /etc/ims/kamailio.cfg
    - source: icscf.xml
      target: /etc/ims/diameter.xml

  scscf:
    << : *kamailio
    configs:
    - source: scscf.cfg
      target: /etc/ims/kamailio.cfg
    - source: scscf.xml
      target: /etc/ims/diameter.xml

  dns:
    image: coredns/coredns
    command: -conf /etc/coredns/Corefile
    configs:
    - source: dns
      target: /etc/coredns/Corefile
    networks:
      default:
        ipv4_address: ${DNS}

  test:
    profiles:
    - test
    command: python3 /opt/test.py scscf ims.mnc${MNC-001}.mcc${MCC-001}.3gppnetwork.org
    environment:
    - IMSI
    - MSISDN
    - K
    - OPC
    depends_on:
      hss:
        condition: service_started
    build:
      context: .
      dockerfile_inline: |
        FROM ubuntu:jammy AS build

        RUN apt update && apt install -y --no-install-recommends \
        git build-essential cmake libtool yasm \
        ragel \
        libsrtp2-dev libssl-dev libopus-dev \
        libspeexdsp-dev \
        libavutil-dev libswscale-dev libavcodec-dev \
        libvpx-dev libyuv-dev libgsm1-dev swig \
        python3-dev  python3-pip
        RUN git clone https://github.com/lyatanski/doubango.git
        WORKDIR doubango
        RUN cmake -B out
        RUN cmake --build out

        FROM ubuntu:jammy
        RUN apt update && apt install -y python3-pip iproute2
        COPY --from=build /doubango/out/_deps/libmnl/usr/lib/libmnl.so* /usr/local/lib/
        COPY --from=build /doubango/out/bindings/python/ /opt/python
        COPY --from=build /doubango/out/plugins/ipsec_linux/ipsec.so /opt/
        RUN ldconfig && pip install /opt/python
    configs:
    - source: test.py
      target: /opt/test.py


configs:
  icscf.cfg:
    file: icscf.cfg

  icscf.xml:
    content: |
      <?xml version="1.0" encoding="UTF-8"?>
      <DiameterPeer
          FQDN="icscf.ims.mnc${MNC-001}.mcc${MCC-001}.3gppnetwork.org"
          Realm="ims.mnc${MNC-001}.mcc${MCC-001}.3gppnetwork.org"
          Vendor_Id="10415"
          Product_Name="CDiameterPeer"
          Workers="1"
      >
              <Peer
                  FQDN="hss.epc.mnc${MNC-001}.mcc${MCC-001}.3gppnetwork.org"
                  Realm="epc.mnc${MNC-001}.mcc${MCC-001}.3gppnetwork.org"
                  port="3868"
              />
              <Auth id="16777216" vendor="10415"/> <!-- Cx 3GPP -->
              <SupportedVendor vendor="10415" />
              <DefaultRoute FQDN="hss.epc.mnc${MNC-001}.mcc${MCC-001}.3gppnetwork.org" metric="1"/>
      </DiameterPeer>

  scscf.cfg:
    file: scscf.cfg

  scscf.xml:
    content: |
      <?xml version="1.0" encoding="UTF-8"?>
      <DiameterPeer
          FQDN="scscf.ims.mnc${MNC-001}.mcc${MCC-001}.3gppnetwork.org"
          Realm="ims.mnc${MNC-001}.mcc${MCC-001}.3gppnetwork.org"
          Vendor_Id="10415"
          Product_Name="CDiameterPeer"
          Workers="1"
      >
              <Peer
                  FQDN="hss.epc.mnc${MNC-001}.mcc${MCC-001}.3gppnetwork.org"
                  Realm="epc.mnc${MNC-001}.mcc${MCC-001}.3gppnetwork.org"
                  port="3868"
              />
              <Auth id="16777216" vendor="10415"/> <!-- Cx 3GPP -->
              <Auth id="4"        vendor="10415"/> <!-- Ro 3GPP -->
              <SupportedVendor vendor="10415" />
              <DefaultRoute FQDN="hss.epc.mnc${MNC-001}.mcc${MCC-001}.3gppnetwork.org" metric="1"/>
      </DiameterPeer>

  dns:
    content: |
      . {
          errors
          log
          health {
             lameduck 5s
          }
          ready
          template IN ANY mnc${MNC-001}.mcc${MCC-001}.3gppnetwork.org {
              match (^|[.])(?P<name>[^.]*).*
              answer "{{ .Name }} 1D IN CNAME {{ .Group.name }}."
              fallthrough
          }
          forward . /etc/resolv.conf
          cache 30
          loop
          reload
          loadbalance
      }

  test.py:
    file: test.py


networks:
  default:
    ipam:
      config:
        - subnet: 192.168.69.0/24
