x-kamailio: &kamailio
  image: ghcr.io/kamailio/kamailio-ci:master-alpine
  command: -f /etc/ims/kamailio.cfg
  dns: ${DNS}

services:
  scscf:
    << : *kamailio
    configs:
    - source: scscf
      target: /etc/ims/kamailio.cfg
    - source: scscf.diameter
      target: /etc/ims/diameter.xml

  dns:
    image: coredns/coredns
    command: -conf /etc/coredns/Corefile
    configs:
    - source: dns
      target: /etc/coredns/Corefile
    networks:
      default:
        ipv4_address: ${DNS}

  hss:
    command: sh /opt/start
    configs:
    - source: hss
      target: /etc/hss/open5gs.yaml
    - source: hss.diameter
      target: /etc/hss/diameter.conf
    - source: hss.start
      target: /opt/start
      mode: 0774
    expose:
    - 3868/tcp
    depends_on:
      mongo:
        condition: service_started
    build:
      context: .
      dockerfile_inline: |
        FROM alpine AS build
        RUN apk add alpine-sdk bison flex git cmake meson bash sudo linux-headers bsd-compat-headers yaml-dev lksctp-tools-dev gnutls-dev libgcrypt-dev libidn-dev mongo-c-driver-dev libmicrohttpd-dev curl-dev nghttp2-dev talloc-dev
        RUN git clone https://github.com/open5gs/open5gs
        WORKDIR open5gs
        RUN meson build --prefix=/opt
        RUN ninja -C build install

        FROM alpine
        RUN apk add yaml lksctp-tools gnutls libgcrypt libidn mongo-c-driver libmicrohttpd curl nghttp2 talloc
        RUN apk add openssl
        COPY --from=build /opt /opt

  ui:
    profiles:
    - ui
    working_dir: /open5gs/webui
    command: npm run dev
    environment:
      DB_URI: mongodb://mongo/open5gs
      HOSTNAME: 0.0.0.0
    ports:
    - 9999:9999
    depends_on:
      mongo:
        condition: service_started
    build:
      context: .
      dockerfile_inline: |
        FROM alpine AS build
        RUN apk add git
        RUN git clone https://github.com/open5gs/open5gs

        FROM alpine
        RUN apk add nodejs npm
        COPY --from=build /open5gs/webui /open5gs/webui
        RUN cd /open5gs/webui && npm ci

  mongo:
    image: mongo:8.0
    command: --bind_ip 0.0.0.0
    expose:
    - 27017/udp
    - 27017/tcp
    configs:
    - source: mongo
      target: /docker-entrypoint-initdb.d/mongo-init.js

  test:
    command: sleep inf
    build:
      context: .
      dockerfile_inline: |
        FROM ubuntu:jammy AS build

        RUN apt update && apt install -y --no-install-recommends \
        git build-essential cmake libtool yasm \
        ragel \
        libsrtp2-dev libssl-dev libopus-dev \
        libspeexdsp-dev \
        libavutil-dev libswscale-dev libavcodec-dev \
        libvpx-dev libyuv-dev libgsm1-dev swig \
        python3-dev  python3-pip
        RUN git clone https://github.com/lyatanski/doubango.git
        WORKDIR doubango
        RUN cmake -B out
        RUN cmake --build out


configs:
  scscf:
    file: scscf/kamailio.cfg

  scscf.diameter:
    file: scscf/diameter.xml

  dns:
    content: |
      . {
          errors
          log
          health {
             lameduck 5s
          }
          ready
          template IN ANY mnc${MNC-001}.mcc${MCC-001}.3gppnetwork.org {
              match (^|[.])(?P<name>[^.]*).*
              answer "{{ .Name }} 1D IN CNAME {{ .Group.name }}."
              fallthrough
          }
          forward . /etc/resolv.conf
          cache 30
          loop
          reload
          loadbalance
      }

  hss.start:
    content: |
      P=/etc/hss/
      openssl req -new -batch -x509 -days 3650 -nodes -newkey rsa:1024 -out $P/crt.pem -keyout $P/key.pem -subj /CN=hss.epc.mnc${MNC}.mcc${MCC}.3gppnetwork.org
      /opt/bin/open5gs-hssd -c /etc/hss/open5gs.yaml -t

  hss:
    content: |
      db_uri: mongodb://mongo/open5gs
      hss:
        freeDiameter: /etc/hss/diameter.conf
          #identity: hss.epc.mnc${MNC}.mcc${MCC}.3gppnetwork.org
          #load_extension:
          #- module: /opt/lib/freeDiameter/dbg_msg_dumps.fdx
          #  conf: 0x4444
          #- module: /opt/lib/freeDiameter/dict_rfc5777.fdx
          #- module: /opt/lib/freeDiameter/dict_mip6i.fdx
          #- module: /opt/lib/freeDiameter/dict_nasreq.fdx
          #- module: /opt/lib/freeDiameter/dict_nas_mipv6.fdx
          #- module: /opt/lib/freeDiameter/dict_dcca.fdx
          #- module: /opt/lib/freeDiameter/dict_dcca_3gpp.fdx
      logger:
        file:
          path: /var/log/hss.log
      global:
        max:
          ue: 1024

  hss.diameter:
    content: |
      Identity = "hss.epc.mnc${MNC}.mcc${MCC}.3gppnetwork.org";
      No_SCTP;
      TLS_Cred = "/etc/hss/crt.pem", "/etc/hss/key.pem";
      TLS_CA = "/etc/hss/crt.pem";

      LoadExtension = "/opt/lib/freeDiameter/dbg_msg_dumps.fdx" : "0x4444";
      LoadExtension = "/opt/lib/freeDiameter/dict_rfc5777.fdx";
      LoadExtension = "/opt/lib/freeDiameter/dict_mip6i.fdx";
      LoadExtension = "/opt/lib/freeDiameter/dict_nasreq.fdx";
      LoadExtension = "/opt/lib/freeDiameter/dict_nas_mipv6.fdx";
      LoadExtension = "/opt/lib/freeDiameter/dict_dcca.fdx";
      LoadExtension = "/opt/lib/freeDiameter/dict_dcca_3gpp.fdx";

      ConnectPeer = "scscf.ims.mnc${MNC}.mcc${MCC}.3gppnetwork.org" { No_TLS; };

  mongo:
    content: |
      db = db.getSiblingDB('open5gs')
      cursor = db.accounts.find()
      if ( cursor.count() == 0 ) {
          db.accounts.insertOne({ salt: 'f5c15fa72622d62b6b790aa8569b9339729801ab8bda5d13997b5db6bfc1d997', hash: '402223057db5194899d2e082aeb0802f6794622e1cbc47529c419e5a603f2cc592074b4f3323b239ffa594c8b756d5c70a4e1f6ecd3f9f0d2d7328c4cf8b1b766514effff0350a90b89e21eac54cd4497a169c0c7554a0e2cd9b672e5414c323f76b8559bc768cba11cad2ea3ae704fb36abc8abc2619231ff84ded60063c6e1554a9777a4a464ef9cfdfa90ecfdacc9844e0e3b2f91b59d9ff024aec4ea1f51b703a31cda9afb1cc2c719a09cee4f9852ba3cf9f07159b1ccf8133924f74df770b1a391c19e8d67ffdcbbef4084a3277e93f55ac60d80338172b2a7b3f29cfe8a36738681794f7ccbe9bc98f8cdeded02f8a4cd0d4b54e1d6ba3d11792ee0ae8801213691848e9c5338e39485816bb0f734b775ac89f454ef90992003511aa8cceed58a3ac2c3814f14afaaed39cbaf4e2719d7213f81665564eec02f60ede838212555873ef742f6666cc66883dcb8281715d5c762fb236d72b770257e7e8d86c122bb69028a34cf1ed93bb973b440fa89a23604cd3fefe85fbd7f55c9b71acf6ad167228c79513f5cfe899a2e2cc498feb6d2d2f07354a17ba74cecfbda3e87d57b147e17dcc7f4c52b802a8e77f28d255a6712dcdc1519e6ac9ec593270bfcf4c395e2531a271a841b1adefb8516a07136b0de47c7fd534601b16f0f7a98f1dbd31795feb97da59e1d23c08461cf37d6f2877d0f2e437f07e25015960f63', username: 'admin', roles: [ 'admin' ], "__v" : 0})
      }

networks:
  default:
    ipam:
      config:
        - subnet: 192.168.69.0/24
